---
import { type CollectionEntry, getCollection } from "astro:content";
import Topbar from "../../components/Topbar.astro";
import Footer from "../../components/Footer.astro";

import {
  SITE_TITLE_SEPARATOR,
  SITE_TITLE,
  SITE_TITLE_DEVANAGRI,
  SITE_DESCRIPTION,
  SITE_DESCRIPTION_DEVANAGRI,
  DEFAULT_ARTICLE_IMAGE,
  Tags,
  Languages,
} from "../../utils/consts";
import MetadataHead from "../../components/MetadataHead.astro";
import ArticleBody from "../../components/ArticleBody.astro";
import SearchModal from "../../components/SearchModal.astro";

export async function getStaticPaths() {
  // IMP NOTE: this genrates the dynamic paths for the current route
  const pages = await getCollection("page");
  return pages.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<"page">;

const post = Astro.props;

const { Content } = await post.render();

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { titleDevanagri, titleEnglish, description, heroImage, pubDate, tags } =
  post.data;

const ogSiteName = `${SITE_TITLE_DEVANAGRI} ${SITE_TITLE_SEPARATOR} ${SITE_TITLE}`;

const postTitleEnglish = `${titleEnglish} ${SITE_TITLE_SEPARATOR} ${SITE_TITLE}`;
const postTitleDevanagri = `${titleDevanagri} ${SITE_TITLE_SEPARATOR} ${SITE_TITLE_DEVANAGRI}`;

const postTitleCombined = `${titleDevanagri} ${SITE_TITLE_SEPARATOR} ${titleEnglish} ${SITE_TITLE_SEPARATOR} ${SITE_TITLE_DEVANAGRI} ${SITE_TITLE_SEPARATOR} ${SITE_TITLE}`;
const postDesciptionCombined = description;

const finalHeroImage = new URL(
  heroImage ? heroImage : DEFAULT_ARTICLE_IMAGE,
  Astro.url
);

const ldSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  publisher: {
    "@type": "Organization",
    name: ogSiteName,
    url: "https://brahmadev.in/",
    logo: {
      "@type": "ImageObject",
      url: "https://brahmadev.in/assets/images/brahma-icon.png",
      width: 60,
      height: 60,
    },
  },
  headline: postTitleCombined,
  url: Astro.url,
  datePublished: pubDate,
  keywords: tags?.length ? tags.join(", ") : "",
  description: postDesciptionCombined,
  mainEntityOfPage: Astro.url,
};
---

<html lang="en">
  <head>
    <MetadataHead />

    <link rel="canonical" href={canonicalURL} />
    <title>{postTitleCombined}</title>

    <meta name="title" lang="en" content={postTitleEnglish} />
    <meta name="description" lang="en" content={description} />

    <meta name="title" lang="hi" content={postTitleDevanagri} />
    <meta name="description" lang="hi" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={postTitleCombined} />
    <meta property="og:site_name" content={ogSiteName} />
    <meta property="og:description" content={postDesciptionCombined} />

    <meta property="og:site_name:locale" content="en_IN" />
    <meta property="og:site_name:locale:alternate" content="hi_IN" />
    <meta property="og:site_name:locale:alternate" content="hi" />
    <meta property="og:site_name:locale:alternate" content="en" />

    <meta property="og:locale" content="en_IN" />
    <meta property="og:locale:alternate" content="hi_IN" />
    <meta property="og:locale:alternate" content="hi" />
    <meta property="og:locale:alternate" content="en" />

    <meta property="og:image" content={finalHeroImage} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={postTitleCombined} />
    <meta property="twitter:description" content={postDesciptionCombined} />
    <meta property="twitter:image" content={finalHeroImage} />
    <meta property="twitter:site" content={"https://brahmadev.in"} />

    <style>
      .m_title {
        display: inline-block;
      }
      .m_title:first-letter {
        text-transform: uppercase;
      }

      .noto-sans-text {
        font-family: "Noto Sans", sans-serif;
        font-optical-sizing: auto;
        font-weight: 300;
        font-style: normal;
        font-variation-settings: "wdth" 100;
      }
    </style>

    <script type="application/ld+json" set:html={JSON.stringify(ldSchema)}>
    </script>
    
  </head>

  <body class="bg-gray-900 min-h-screen">
    <Topbar />
    <SearchModal />

    <!-- Hero Section with Background -->
    <div class="relative pt-20 pb-8 bg-gradient-to-b from-gray-900 via-slate-900 to-gray-800">
      <div class="max-w-5xl mx-auto px-4">
        <!-- Tags -->
        <div class="flex flex-wrap justify-center gap-2 mb-6">
          {
            post.data?.tags?.map((tag: any) =>
              Tags.includes(tag) ? (
                <a
                  href={`/tags/${tag}`}
                  class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 
                         rounded-full px-4 py-1.5 text-sm font-semibold text-white transition-all duration-300 
                         hover:scale-105 shadow-lg"
                >
                  #{tag}
                </a>
              ) : (
                <span
                  class="bg-gradient-to-r from-orange-500 to-red-500 rounded-full px-4 py-1.5 
                         text-sm font-semibold text-white shadow-lg"
                >
                  #{tag}
                </span>
              )
            )
          }
        </div>

        <!-- Title Section -->
        <div class="text-center mb-8">
          <h1 class="text-3xl md:text-5xl font-bold text-yellow-400 font-serif mb-3 noto-sans-text">
            {titleDevanagri}
          </h1>
          <h2 class="text-xl md:text-2xl text-white/90 font-medium">
            {titleEnglish}
          </h2>
          {description && (
            <p class="text-white/70 mt-4 max-w-3xl mx-auto leading-relaxed">
              {description}
            </p>
          )}
        </div>

        <!-- Language Selector -->
        {
          post.data.availableLanguages && post.data.availableLanguages.length > 0 && (
            <div class="bg-slate-800/60 backdrop-blur-sm rounded-xl p-6 border border-yellow-400/20 max-w-2xl mx-auto">
              <h3 class="text-lg font-semibold text-yellow-400 mb-4 text-center">
                Choose Translation Language
              </h3>
              <div class="flex gap-4 justify-center flex-wrap">
                {Languages.filter((item) =>
                  post.data?.availableLanguages?.includes(item.label)
                ).map((item) => (
                  <button
                    title={`Show ${item.label} Translation`}
                    id={`lang-${item.label}`}
                    aria-label={`Show ${item.label} Translation`}
                    class="group relative border-2 border-gray-600 text-white rounded-lg font-bold 
                           h-16 w-16 flex flex-col items-center justify-center transition-all duration-300 
                           hover:border-yellow-400 hover:bg-yellow-400/10 hover:scale-110"
                  >
                    <span class="text-2xl">{item.symbol}</span>
                    <span class="text-[10px] mt-1 capitalize text-white/70 group-hover:text-yellow-400">
                      {item.label}
                    </span>
                  </button>
                ))}
              </div>
            </div>
          )
        }
      </div>
    </div>

    <!-- Main Content Section -->
    <main class="relative py-12 bg-gray-900">
      <div class="max-w-4xl mx-auto px-4">
        <!-- Sacred Content Card -->
        <article class="bg-gradient-to-br from-slate-800/80 to-slate-700/80 backdrop-blur-sm 
                        rounded-2xl border border-yellow-400/20 shadow-2xl overflow-hidden">
          
          <!-- Decorative Top Border -->
          <div class="h-1 bg-gradient-to-r from-transparent via-yellow-400 to-transparent"></div>
          
          <!-- Content Area -->
          <div class="p-6 md:p-10 lg:p-12">
            <ArticleBody
              data={post.data}
              availableLanguages={post.data.availableLanguages || []}
              Content={Content}
            />
          </div>

          <!-- Decorative Bottom Border -->
          <div class="h-1 bg-gradient-to-r from-transparent via-yellow-400 to-transparent"></div>
        </article>

        <!-- Source Information Card -->
        {(post.data.sourceName || post.data.sourceDescription || post.data.sourceLink || post.data.extraInfo) && (
          <div class="mt-8 bg-slate-800/60 backdrop-blur-sm rounded-xl p-6 md:p-8 border border-slate-700">
            <h3 class="text-xl font-bold text-yellow-400 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Source & Additional Information
            </h3>
            
            <div class="space-y-3 text-white/80 text-sm leading-relaxed">
              {post.data.sourceName && (
                <div>
                  <span class="font-semibold text-yellow-300">Source: </span>
                  <span set:html={post.data.sourceName} />
                </div>
              )}

              {post.data.sourceDescription && (
                <div class="text-white/70" set:html={post.data.sourceDescription} />
              )}

              {post.data.sourceLink && (
                <div>
                  <span class="font-semibold text-yellow-300">Reference Link: </span>
                  <a
                    href={post.data.sourceLink}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-blue-400 hover:text-blue-300 hover:underline transition-colors"
                  >
                    {post.data.sourceLink.length > 60 
                      ? post.data.sourceLink.substring(0, 60) + "..." 
                      : post.data.sourceLink}
                  </a>
                </div>
              )}

              {post.data.extraInfo && (
                <div class="mt-4 pt-4 border-t border-slate-700">
                  <span class="font-semibold text-yellow-300 block mb-2">Additional Information:</span>
                  <div class="text-white/70" set:html={post.data.extraInfo} />
                </div>
              )}
            </div>
          </div>
        )}

        <!-- Related Tags Section -->
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="mt-8 text-center">
            <p class="text-white/60 text-sm mb-3">Explore more content:</p>
            <div class="flex flex-wrap justify-center gap-2">
              {post.data.tags.map((tag: any) =>
                Tags.includes(tag) ? (
                  <a
                    href={`/tags/${tag}`}
                    class="bg-slate-800/60 hover:bg-slate-700/60 text-white/80 hover:text-yellow-400 
                           rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 
                           border border-slate-700 hover:border-yellow-400/40"
                  >
                    View all {tag}
                  </a>
                ) : null
              )}
            </div>
          </div>
        )}
      </div>
    </main>

    <Footer />
  </body>
</html>
